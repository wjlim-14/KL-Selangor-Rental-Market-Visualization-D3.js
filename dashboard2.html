<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v7.js"></script>

<head>
    <title>Chart Visualization Dashboard</title>

    <style>
        body {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            font-size: 14px;
        }
        h1 {
            text-align: center;
        }
        h2 {
            text-align: center;
            border: 1px solid black;
            padding: 5px;
            background-color: lightgray;
        }
        .topnav {
            background-color: #be3455;
            overflow: hidden;
        }
        .topnav a {
            float: left;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            font-size: 17px;
        }
        .topnav a:hover {
            background-color: #ffa7ca;
            color: black;
        }
        .topnav a.active {
            background-color: #1a6b54;
            color: white;
        }
        .location-filter {
            position: fixed;
            top: 70px;
            left: 10px;
            background-color: #ffa7ca;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }
        .donut-filter {
            text-align: center;
        }
        .chart-container {
            display: flex;
            justify-content: center;
        }
        .tooltip {
            position: absolute;
            padding: 8px;
            background-color: #f9f9f9;
            border: 1px solid #d3d3d3;
            pointer-events: none;
            font-size: 12px;
        }
        #tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
        }
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin: 5px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            margin-right: 5px;
            display: inline-block;
        }

        .legend-label {
            font-size: 12px;
            display: inline-block;
        }

    </style>
</head>

<body>
    <div class="topnav">
        <a class="active">KL-Selangor Rental Market</a>
        <a href="dashboard1.html">Map</a>
        <a href="dashboard2.html">Charts</a>
    </div>

    <h1>Chart Overview of Property for Rent in KL-Selangor</h1>

    <div class="location-filter">
        <label for="location">Location:</label>
        <select id="location" onchange="updateAll()">
            <option value="all">All Locations</option>
        </select>
    </div>
    
    <h2 id="bar-graph-title">Graph 1</h2>
    <div class="chart-container">
        <div>
            <label for="sort">Sort Order:</label>
            <select id="sort" onchange="update()">
                <option value="default">Default</option>
                <option value="ascending">Ascending</option>
                <option value="descending">Descending</option>
            </select>
        </div>
        <div id="bar_chart"></div>
    </div>
    
    <h2 id="treemap-title">Graph 2</h2>
    <div class="chart-container">
        <div id="treemap-chart"></div>
    </div>

    <h2 id="line-chart-title">Graph 3</h2>
    <div class="chart-container">
        <div id="line-chart"></div>
    </div>

    <h2 id="donut-chart-title">Graph 4</h2>
    <div class="donut-filter">
        <label for="checkbox">Filter By:</label>
        <input type="radio" name="filter" value="rooms" checked>Rooms
        <input type="radio" name="filter" value="bathroom">Bathroom
        <input type="radio" name="filter" value="parking">Parking
        <div id="donut-legend"></div>
    </div>
    <div class="chart-container">
        <div id="tooltip"></div>
        <div id="donut_charts"></div>
    </div>

    <script>

        function updateAll() {

            d3.csv("mudah-apartment-kl-selangor-cleaned.csv").then(function(data) {
    
                // update the location dropdown options
                const selectedLocation = document.getElementById("location").value;
                const uniqueLocations = Array.from(new Set(data.map(d => d.location)));
                
                const locationDropdown = document.getElementById("location");
                locationDropdown.innerHTML = '<option value="all">All Locations</option>';

                uniqueLocations.sort();

                uniqueLocations.forEach(location => {
                    const option = document.createElement("option");
                    option.text = location;
                    locationDropdown.add(option);
                });

                // set the selected location from the location filter
                locationDropdown.value = selectedLocation;

                // filter the data based on the selected location
                const filteredData = selectedLocation !== "all" ? data.filter(d => d.location === selectedLocation) : data;

                // a function to draw the property type count bar chart
                function barchart(filteredData) {
                    d3.select("#bar_chart").selectAll("svg").remove();
                    
                    // set and update chart title
                    var barchart_title = document.getElementById("bar-graph-title");
                    barchart_title.textContent = selectedLocation !== "all" ? `Count of Property Types based on ${selectedLocation}` : "Count of Property Types";

                    // set the dimensions and margins of the graph
                    const barchartMargin = { top: 30, right: 30, bottom: 90, left: 60 }, 
                        barchartWidth = 400 - barchartMargin.left - barchartMargin.right,
                        barchartHeight = 500 - barchartMargin.top - barchartMargin.bottom;

                    // append the bar chart svg object to the body of the page
                    const barchartSvg = d3.select("#bar_chart")
                        .append("svg")
                        .attr("width", barchartWidth + barchartMargin.left + barchartMargin.right)
                        .attr("height", barchartHeight + barchartMargin.top + barchartMargin.bottom)
                        .append("g")
                        .attr("transform", `translate(${barchartMargin.left},${barchartMargin.top})`);

                    // initialize the X axis
                    const x = d3.scaleBand()
                        .range([0, barchartWidth])
                        .padding(0.2);
                    const xAxis = barchartSvg.append("g")
                        .attr("transform", `translate(0,${barchartHeight})`);

                    // initialize the Y axis
                    const y = d3.scaleLinear()
                        .range([barchartHeight, 0]);
                    const yAxis = barchartSvg.append("g")
                        .attr("class", "myYaxis");

                    // a function that creates/updates the plot
                    function update() {

                        // calculate the total count for each property type
                        const propertyTypeCounts = d3.rollup(
                            filteredData,
                            v => v.length,
                            d => d.property_type
                        );

                        // convert propertyTypeCounts to an array of objects
                        const countsArray = Array.from(propertyTypeCounts, ([propertyType, count]) => ({ propertyType, count }));

                        // sort the data based on the selected sort order
                        const sortOrder = document.getElementById("sort").value;

                        if (sortOrder === "ascending") {
                            countsArray.sort(function (a, b) {
                                return d3.ascending(a.count, b.count);
                            });
                        } else if (sortOrder === "descending") {
                            countsArray.sort(function (a, b) {
                                return d3.descending(a.count, b.count);
                            });
                        }

                        // x-axis
                        x.domain(countsArray.map(function (d) { return d.propertyType; }));
                        xAxis.transition()
                            .duration(1000)
                            .call(d3.axisBottom(x).tickSizeOuter(0))
                            .selectAll("text")
                            .style("text-anchor", "end")
                            .attr("dx", "-.8em")
                            .attr("dy", ".15em")
                            .attr("transform", "rotate(-45)");

                        // y-axis
                        y.domain([0, d3.max(countsArray, function (d) { return d.count; })]);
                        yAxis.transition()
                            .duration(1000)
                            .call(d3.axisLeft(y));

                        // x axis label
                        barchartSvg.append("text")
                            .attr("transform", `translate(${barchartWidth / 2}, ${barchartHeight+45 + barchartMargin.top + 10})`)
                            .style("text-anchor", "middle")
                            .text("Types of Property");

                        // y axis label
                        barchartSvg.append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 0 - barchartMargin.left)
                            .attr("x", 0 - (barchartHeight / 2))
                            .attr("dy", "1em")
                            .style("text-anchor", "middle")
                            .text("Total Count");

                        d3.select("#bar_chart")
                            .selectAll("svg")
                            .select("g")
                            .select("#title")
                            .remove();

                        // variable u: map data to existing bars
                        const u = barchartSvg.selectAll(".bar")
                            .data(countsArray);

                        // update bars
                        u.join("rect")
                            .attr("class", "bar")
                            .transition()
                            .duration(1000)
                            .attr("x", function (d) { return x(d.propertyType); })
                            .attr("y", function (d) { return y(d.count); })
                            .attr("width", x.bandwidth())
                            .attr("height", function (d) { return barchartHeight - y(d.count); })
                            .attr("fill", "#69b3a2");

                        // add total count labels on top of each bar
                        barchartSvg.selectAll(".count-label").remove(); // remove existing count labels
                        barchartSvg.selectAll(".count-label")
                            .data(countsArray)
                            .join("text")
                            .attr("class", "count-label")
                            .attr("x", function (d) { return x(d.propertyType) + x.bandwidth() / 2; })
                            .attr("y", function (d) { return y(d.count); })
                            .attr("text-anchor", "middle")
                            .text(function (d) { return d.count; })
                            .transition()
                            .duration(1000)
                            .attrTween("y", function (d) {
                                var interpolate = d3.interpolate(0, y(d.count) - 5);
                                return function (t) {
                                    return interpolate(t);
                                };
                            });
                    }

                    // initialize the plot
                    update();

                    // event listener for sortOrder option change
                    d3.select("#sort").on("change", update);
                }

                // a function to draw the donut chart
                function donutChart(filteredData, selectedLocation) {
                    // set the dimensions and margins of the graph
                    const width = 220,
                        height = 220,
                        margin = 10;

                    // the radius of the pieplot is half the width or half the height (smallest one). Subtract a bit of margin.
                    const radius = Math.min(width, height) / 2 - margin;
                    const innerRadius = radius * 0.5;

                    // a function that creates/updates the plot
                    function update() {
                        // get the selected filter
                        const selectedFilter = document.querySelector('input[name="filter"]:checked').value;

                        // set and update chart title
                        var donutchart_title = document.getElementById("donut-chart-title");
                        donutchart_title.textContent = selectedLocation !== "all" ? `Number of  ${selectedFilter} by Property Types in ${selectedLocation}`  : "Number of  rooms by Property Types";

                        // group the data by property type and rooms
                        const groupedData = d3.group(filteredData, d => d.property_type, d => d[selectedFilter]);

                        // calculate the count for each property type and filter category
                        const propertyTypeCounts = Array.from(groupedData, ([propertyType, filterData]) => {
                            const count = {
                                propertyType,
                                filters: Array.from(filterData, ([filter, properties]) => ({
                                    category: filter,
                                    count: properties.length
                                }))
                            };
                            return count;
                        });

                        const donutChartsContainer = d3.select("#donut_charts");

                        const donutCharts = donutChartsContainer.selectAll(".donut_chart")
                            .data(propertyTypeCounts, d => d.propertyType);

                        // enter selection
                        const enterDonutCharts = donutCharts.enter()
                            .append("div")
                            .attr("class", "donut_chart")
                            .style("float", "left")
                            .style("margin", "20px");

                        enterDonutCharts.append("h3")
                            .text(d => d.propertyType);

                        enterDonutCharts.append("svg")
                            .attr("width", width)
                            .attr("height", height)
                            .append("g")
                            .attr("transform", `translate(${width / 2},${height / 2})`);

                        // update selection
                        const mergedDonutCharts = enterDonutCharts.merge(donutCharts);

                        mergedDonutCharts.select("h3")
                            .text(d => d.propertyType);

                        // set the color scale
                        const color = d3.scaleOrdinal()
                            .domain(["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "More than 10"])
                            .range(["#ff7f0e", "#1f77b4", "#2ca02c", "#9467bd", "#d62728", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf", "#636363"]);

                        // Create the legend
                        const legendContainer = d3.select("#donut-legend");

                        // Remove any existing legend items
                        legendContainer.selectAll(".legend-item").remove();

                        // Append a legend item for each color category
                        const legendItems = legendContainer.selectAll(".legend-item")
                            .data(color.domain())
                            .enter()
                            .append("div")
                            .attr("class", "legend-item");

                        legendItems.append("div")
                            .attr("class", "legend-color")
                            .style("background-color", d => color(d));

                        legendItems.append("div")
                            .attr("class", "legend-label")
                            .text(d => d);

                        // update the donut charts
                        mergedDonutCharts.each(function (d) {
                            const svg = d3.select(this)
                                .select("svg")
                                .select("g");

                            // compute the position of each group on the pie
                            const pie = d3.pie()
                                .value(d => d.count);

                            const dataReady = pie(d.filters);

                            // build the donut chart
                            const arcs = svg.selectAll('path')
                            .data(dataReady);

                            arcs.enter()
                                .append('path')
                                .merge(arcs)
                                .attr('d', d3.arc()
                                    .innerRadius(innerRadius)
                                    .outerRadius(radius)
                                )
                                .attr('fill', d => color(Math.floor(d.data.category).toString()))                                
                                .attr("stroke", "white")
                                .style("stroke-width", "2px")
                                .style("opacity", 0.7)
                                .on("mouseover", function (event, d) {
                                    d3.select(this)
                                        .transition()
                                        .duration(200)
                                        .style("opacity", 1);
                                        showTooltip(event, d.data.category, d.data.count, selectedFilter);
                                })
                                .on("mouseout", function () {
                                    d3.select(this)
                                        .transition()
                                        .duration(200)
                                        .style("opacity", 0.7);
                                        hideTooltip();
                                });

                            arcs.exit().remove();
                        });

                        // exit selection
                        donutCharts.exit().remove();
                    }

                        // update the plot when the selected filter changes
                        document.querySelectorAll('input[name="filter"]').forEach(function (radio) {
                            radio.addEventListener("change", update);
                        });

                    // a function to show the tooltip
                    function showTooltip(event, label, count, selectedFilter) {
                        const tooltip = document.getElementById("tooltip");
                        tooltip.style.left = event.pageX + "px";
                        tooltip.style.top = event.pageY + "px";
                        tooltip.style.opacity = 1;

                        let tooltipLabel = "";

                        if (selectedFilter === "rooms") {
                            tooltipLabel = "Number of Rooms:";
                        } else if (selectedFilter === "bathroom") {
                            tooltipLabel = "Number of Bathrooms:";
                        } else if (selectedFilter === "parking") {
                            tooltipLabel = "Number of Parking Spaces:";
                        }

                        tooltip.innerHTML = `${tooltipLabel} ${Math.round(label)} <br> Total Count: ${count}`;
                    }

                    // a function to hide the tooltip
                    function hideTooltip() {
                        const tooltip = document.getElementById("tooltip");
                        tooltip.style.opacity = 0;
                    }

                    // initialize the plot
                    update();
                }
    
                // a function to draw the average rental treemap
                function treemap(filteredData) {
                    // set the dimensions and margins of the graph
                    const margin = {top: 30, right: 20, bottom: 30, left: 20};
                    const width = 600 - margin.left - margin.right;
                    const height = 500 - margin.top - margin.bottom;

                    // append the svg object to the body of the page
                    const svg = d3.select("#treemap-chart")
                        .append("svg")
                        .attr("width", "100%")
                        .attr("height", "100%")
                        .attr("viewBox", "0 0 450 350")
                        .attr("preserveAspectRatio", "xMinYMin")
                        .append("g")
                        .attr("transform", `translate(${margin.left}, ${margin.top})`);

                    function update() {
                        // convert rent values to numbers
                        filteredData.forEach(function(d) {
                            d.monthly_rent = +d.monthly_rent;
                        });

                        // group data by furnish condition and calculate average rent
                        var furnishGroup = d3.group(filteredData, d => d.furnished);
                        var furnishAvg = Array.from(furnishGroup, ([furnishCondition, properties]) => {
                            var averageRent = d3.mean(properties, d => d.monthly_rent);
                            return { furnishCondition: furnishCondition, averageRent: averageRent };
                        });

                        // sort property types by average rent in descending order
                        furnishAvg.sort((a, b) => b.averageRent - a.averageRent);

                        // create a tree map layout
                        var treemap = d3.treemap()
                            .size([width, height])
                            .padding(1);

                        // set up the tree map hierarchy
                        var root = d3.hierarchy({ children: furnishAvg })
                            .sum(d => d.averageRent)
                            .sort((a, b) => b.averageRent - a.averageRent);

                        // generate the tree map layout
                        treemap(root);

                        const colorScale = d3.scaleOrdinal()
                            .domain(["Fully Furnished", "Not Furnished", "Partially Furnished"])
                            .range(["#ff7f0e", "#1f77b4", "#2ca02c"]);

                        var treemapOpacity = d3.scaleLinear()
                            .domain([1000, 5000])
                            .range([.2, 1])

                        // draw the initial treemap
                        drawFurnishTreemap(root);

                        // a function to draw the average rental by property types
                        function clickFurnish(event, d) {
                            // get the selected furnish condition
                            var clickedRect = d3.select(this);
                            var rectColor = d3.select(clickedRect.node()).attr("fill");
                            
                            // clear the existing treemap with a transition
                            d3.select("#treemap-chart")
                                .selectAll("svg")
                                .transition()
                                .style("opacity", 0)
                                .remove()
                                .end()
                                .then(() => {

                                    // filter the data for the selected furnish condition
                                    selectedFurnish = d.data.furnishCondition;
                                    const furnishData = filteredData.filter(item => item.furnished === selectedFurnish);
                                        
                                    // set and update chart title
                                    var treemap_title = document.getElementById("treemap-title");
                                    treemap_title.textContent = selectedLocation !== "all" ? `Average Rental for ${selectedFurnish} in ${selectedLocation}` : "Average Rental for Different Furnish Conditions";
                                    
                                    // group data by property type and calculate average rent
                                    var propertyGroup = d3.group(furnishData, d => d.property_type);
                                    var propertyAvg = Array.from(propertyGroup, ([propertyType, properties]) => {
                                        var averageRent = d3.mean(properties, d => d.monthly_rent);
                                        return { propertyType: propertyType, averageRent: averageRent };
                                    });

                                    // sort property types by average rent in descending order
                                    propertyAvg.sort((a, b) => b.averageRent - a.averageRent);

                                    // create a tree map layout
                                    var PropertyTypeTreemap = d3.treemap()
                                        .size([width, height])
                                        .padding(1);

                                    // set up the tree map hierarchy
                                    var propertyTypeRoot = d3.hierarchy({ children: propertyAvg })
                                        .sum(d => d.averageRent)
                                        .sort((a, b) => b.averageRent - a.averageRent);

                                    // generate the tree map layout
                                    PropertyTypeTreemap(propertyTypeRoot);

                                    var svg = d3.select("#treemap-chart")
                                        .append("svg")
                                        .attr("width", width)
                                        .attr("height", height);

                                    var propertyTypeNodes = svg.selectAll("g")
                                        .data(propertyTypeRoot.leaves())
                                        .enter()
                                        .append("g");

                                    // append a rectangle for each property type
                                    var propertyTypeRects = propertyTypeNodes.append("rect")
                                        .attr("x", d => d.x0)
                                        .attr("y", d => d.y0)
                                        .attr("width", 0) 
                                        .attr("height", 0) 
                                        .style("fill", d => colorScale(selectedFurnish))
                                        .style("opacity", function(d){ return treemapOpacity(d.data.averageRent)});

                                    // transition to expand the rectangles
                                    propertyTypeRects.transition()
                                        .duration(1000)
                                        .attr("x", d => d.x0)
                                        .attr("y", d => d.y0)
                                        .attr("width", d => d.x1 - d.x0)
                                        .attr("height", d => d.y1 - d.y0);

                                    // tooltip
                                    propertyTypeRects.append("title")
                                        .text(d => `${d.data.propertyType}\nAverage Rent: ${Math.round(d.data.averageRent)}\nFurnished: ${selectedFurnish}`);

                                    // append text for each property type
                                    propertyTypeNodes.append("text")
                                        .attr("x", d => (d.x1 - d.x0) / 2 + d.x0)
                                        .attr("y", d => (d.y1 - d.y0) / 2 + d.y0)
                                        .attr("dy", "-0.5em")
                                        .attr("text-anchor", "middle")
                                        .style("pointer-events", "none")
                                        .text(d => `${d.data.propertyType}`)
                                        .append("tspan")
                                        .attr("x", d => (d.x1 - d.x0) / 2 + d.x0)
                                        .attr("y", d => (d.y1 - d.y0) / 2 + d.y0)
                                        .attr("dy", "1em")
                                        .style("pointer-events", "none")
                                        .text(d => `RM${Math.round(d.data.averageRent)}`);

                                    // add event listener to handle clicks outside the treemap
                                    svg.on("click", () => {
                                        // clear the existing treemap
                                        d3.select("#treemap-chart").selectAll("svg").remove();

                                        // redraw the initial treemap
                                        drawFurnishTreemap(root);
                                    });
                                });
                            }

                        // a function to draw the average rental by furnish condition
                        function drawFurnishTreemap(root) {
                            d3.select("#treemap-chart").selectAll("svg").remove();

                            // set and update chart title
                            var treemap_title = document.getElementById("treemap-title");
                            treemap_title.textContent = selectedLocation !== "all" ? `Average Rental for Different Furnish Conditions in ${selectedLocation}` : "Average Rental for Different Furnish Conditions";

                            // create SVG and append rectangles for each property type
                            var svg = d3.select("#treemap-chart")
                                .append("svg")
                                .attr("width", width)
                                .attr("height", height);

                            var nodes = svg.selectAll("g")
                                .data(root.leaves())
                                .enter()
                                .append("g")
                                .attr("transform", d => `translate(${d.x0},${d.y0})`);

                            // append a rectangle for each property type
                            var rects = nodes.append("rect")
                                    .attr("width", 0)
                                    .attr("height", 0)
                                    .attr("fill", d => colorScale(d.data.furnishCondition))
                                    .on("click", clickFurnish);

                            // transition to expand the rectangles
                            rects.transition()
                                .duration(1000)
                                .attr("width", d => d.x1 - d.x0)
                                .attr("height", d => d.y1 - d.y0);

                            // tooltip
                            rects.append("title")
                                .text(d => `${d.data.furnishCondition}\nAverage Rent: ${Math.round(d.data.averageRent)}`);

                            // append text for each property type
                            nodes.append("text")
                                .attr("x", d => (d.x1 - d.x0) / 2)
                                .attr("y", d => (d.y1 - d.y0) / 2)
                                .attr("dy", "-0.7em")
                                .attr("text-anchor", "middle")
                                .style("pointer-events", "none")
                                .text(d => d.data.furnishCondition)
                                .append("tspan")
                                .attr("x", d => (d.x1 - d.x0) / 2)
                                .attr("y", d => (d.y1 - d.y0) / 2)
                                .attr("dy", "0.7em")
                                .style("pointer-events", "none")
                                .text(d => `RM${Math.round(d.data.averageRent)}`);
                        }
                    }

                    update()
                };

                // a function to draw the property count by completion year line chart
                function linechart(filteredData) {
                    d3.select("#line-chart").selectAll("svg").remove();

                    // set and update chart title
                    var linechart_title = document.getElementById("line-chart-title");
                    linechart_title.textContent = selectedLocation !== "all" ? `Property Type Count by Completion Year in ${selectedLocation}` : "Property Type Count by Completion Year";

                    // set the dimensions and margins of the graph
                    const margin = {top: 20, right: 90, bottom: 60, left: 60},
                        width = 960 - margin.left - margin.right,
                        height = 500 - margin.top - margin.bottom;

                    // append the SVG object to the body of the page
                    const svg = d3.select("#line-chart")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", `translate(${margin.left},${margin.top})`);

                    // tooltip
                    const tooltip = d3.select("#line-chart")
                        .append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0);

                    const x = d3.scaleLinear()
                        .range([0, width]);
                    const xAxis = svg.append("g")
                        .attr("transform", `translate(0, ${height})`)

                    const y = d3.scaleLinear()
                        .range([height, 0]);
                    const yAxis = svg.append("g")
                        .attr("class", "myYaxis");
    
                    // a function that filters the data based on the selected location
                    function update() {
                        filteredDate = filteredData.filter(d => d.completion_year !== "");
                        filteredDate.forEach(function(d) {
                            d.completion_year = +d.completion_year;
                        });

                        // group the data by property type and completion year
                        const groupedData = d3.group(filteredDate, d => d.property_type, d => d.completion_year);

                        // calculate the count for each property type and completion year
                        const sumstat = Array.from(groupedData, ([propertyType, yearsData]) => {
                            const countByYear = Array.from(yearsData, ([completionYear, properties]) => ({
                            completion_year: completionYear,
                            count: properties.length
                            }));
                            return { property_type: propertyType, data: countByYear };
                        });

                        // get all unique completion years
                        const years = data.map(d => d.completion_year);

                        // color palette
                        const color = d3.scaleOrdinal(d3.schemeCategory10)
                            .domain(data.map(d => d.property_type));

                        x.domain(d3.extent(filteredDate, function(d) { return d.completion_year; }));
                        xAxis.transition()
                            .duration(1000)
                            .call(d3.axisBottom(x).tickSizeOuter(0).tickFormat(d3.format("d")))
                            .selectAll("text")
                            .style("text-anchor", "end")
                            .attr("dx", "-.8em")
                            .attr("dy", ".15em")
                            .attr("transform", "rotate(-45)");

                        y.domain([0, d3.max(sumstat, d => d3.max(d.data, d => d.count))]);
                        yAxis.transition()
                            .duration(1000)
                            .call(d3.axisLeft(y));

                        svg.append("text")
                            .attr("class", "axis-title")
                            .attr("text-anchor", "middle")
                            .attr("x", width / 2)
                            .attr("y", height + margin.top + 20) 
                            .text("Completion Year");

                        svg.append("text")
                            .attr("class", "axis-title")
                            .attr("text-anchor", "middle")
                            .attr("transform", "rotate(-90)")
                            .attr("x", -height / 2)
                            .attr("y", -margin.left + 20)
                            .text("Count of Property Type");

                        // draw the lines
                        const line = d3.line()
                            .x(function (d) { return x(d.completion_year);}) 
                            .y(function (d) { return y(d.count); });

                        svg.selectAll(".line").remove();
                        
                        svg.selectAll(".line")
                            .data(sumstat)
                            .enter()
                            .append("path")
                            .attr("class", "line")
                            .attr("fill", "none")
                            .attr("stroke", d => color(d.property_type))
                            .attr("stroke-width", 1.5)
                            .attr("d", d => line(d.data.sort((a, b) => a.completion_year - b.completion_year).map(entry => ({ completion_year: entry.completion_year, count: entry.count }))))
                            .attr("stroke-dasharray", function () { return this.getTotalLength() })
                            .attr("stroke-dashoffset", function () { return this.getTotalLength() })
                            .on("mouseover", function(event, d) {
                                // get the x-coordinate of the mouse position
                                const mouseX = d3.pointer(event)[0];

                                // find the data point closest to the x-coordinate
                                const yearData = d.data.find(entry => Math.abs(x(entry.completion_year) - mouseX) < 10);

                                // retrieve the count value for the specific year
                                const count = yearData ? yearData.count : 0;

                                tooltip.transition()
                                    .style("opacity", 0.9);
                                tooltip.html(d.property_type + "<br/>" + "Year: " + yearData.completion_year + "<br/>" + "Count: " + count)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 15) + "px");
                                })

                            .on("mouseout", function () {
                                    tooltip.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                            })
                            .transition()
                            .duration(2000)
                            .ease(d3.easeLinear)
                            .attr("stroke-dashoffset", 0);

                        const legend = svg.selectAll(".legend")
                            .data(sumstat)
                            .enter()
                            .append("g")
                            .attr("class", "legend")
                            .attr("transform", (d, i) => `translate(90, ${i * 20})`);

                        legend.append("rect")
                            .attr("x", width - 23)
                            .attr("width", 18)
                            .attr("height", 18)
                            .style("fill", d => color(d.property_type));

                        legend.append("text")
                            .attr("x", width - 26)
                            .attr("y", 9)
                            .attr("dy", "0.35em")
                            .style("text-anchor", "end")
                            .text(d => d.property_type);
                    }

                    update();
                }
        
                barchart(filteredData);
                treemap(filteredData);
                linechart(filteredData);
                donutChart(filteredData, selectedLocation);
                
            });
        }

        updateAll();

    </script>
</html>
